function MarvinColorModelConverter(){}function MarvinImage(t,e,i){this.image=null,this.canvas=null,this.ctx=null,this.data=null,this.colorModel=null==i?MarvinImage.COLOR_MODEL_RGB:i,null!=t&&this.create(t,e),i==MarvinImage.COLOR_MODEL_BINARY&&(this.arrBinaryColor=new Array(t*e))}function MarvinImageMask(t,e){this.width=t,this.height=e,this.arrMask=0!=t&&0!=e?MarvinJSUtils.createMatrix2D(width,height):null}function MarvinSegment(t,e,i,r){this.x1=-1,this.x2=-1,this.y1=-1,this.y2=-1,-1!=t&&-1!=e&&-1!=i&&-1!=r&&(this.width=i-t+1,this.height=r-e+1,this.area=this.width*this.height)}function MarvinColor(t,e,i){return this.red=t,this.green=e,this.blue=i,this}function GaussianBlur(){MarvinAbstractImagePlugin.super(this),this.load()}function AlphaBoundary(){MarvinAbstractImagePlugin.super(this),this.load()}function BlackAndWhite(){MarvinAbstractImagePlugin.super(this),this.MAX_RLEVEL=.03,this.load()}function BrightnessAndContrast(){MarvinAbstractImagePlugin.super(this),this.load()}function ColorChannel(){MarvinAbstractImagePlugin.super(this),this.load()}function Emboss(){MarvinAbstractImagePlugin.super(this),this.load()}function GrayScale(){MarvinAbstractImagePlugin.super(this),this.load()}function Invert(){MarvinAbstractImagePlugin.super(this),this.load()}function Sepia(){MarvinAbstractImagePlugin.super(this),this.load()}function Thresholding(){MarvinAbstractImagePlugin.super(this),this.load(),this.threshold=null,this.thresholdRange=null,this.neighborhood=null,this.range=null}function ThresholdingNeighborhood(){MarvinAbstractImagePlugin.super(this),this.load()}function Convolution(){MarvinAbstractImagePlugin.super(this),this.load()}function Moravec(){MarvinAbstractImagePlugin.super(this),this.load()}function Prewitt(){MarvinAbstractImagePlugin.super(this),this.matrixPrewittX=[[1,0,-1],[1,0,-1],[1,0,-1]],this.matrixPrewittY=[[1,1,1],[0,0,0],[-1,-1,-1]],this.load()}function BoundaryFill(){MarvinAbstractImagePlugin.super(this),this.load()}function ErrorDiffusion(){MarvinAbstractImagePlugin.super(this),this.load()}function Closing(){MarvinAbstractImagePlugin.super(this),this.load()}function Dilation(){MarvinAbstractImagePlugin.super(this),this.load()}function Erosion(){MarvinAbstractImagePlugin.super(this),this.load()}function Crop(){MarvinAbstractImagePlugin.super(this),this.load()}function FloodfillSegmentation(){MarvinAbstractImagePlugin.super(this),this.load()}function Scale(){MarvinAbstractImagePlugin.super(this),this.load()}function MarvinAttributes(){this.hashAttributes=new Object}function MarvinPoint(t,e){this.x=t,this.y=e}MarvinColorModelConverter.rgbToBinary=function(t,e){for(var i=new MarvinImage(t.getWidth(),t.getHeight(),MarvinImage.COLOR_MODEL_BINARY),r=0;r<t.getHeight();r++)for(var n=0;n<t.getWidth();n++)Math.ceil(.3*t.getIntComponent0(n,r)+.59*t.getIntComponent1(n,r)+.11*t.getIntComponent2(n,r))<=e?i.setBinaryColor(n,r,!0):i.setBinaryColor(n,r,!1);return i},MarvinColorModelConverter.binaryToRgb=function(t){for(var e=new MarvinImage(t.getWidth(),t.getHeight(),MarvinImage.COLOR_MODEL_RGB),i=0;i<t.getHeight();i++)for(var r=0;r<t.getWidth();r++)t.getBinaryColor(r,i)?e.setIntColor(r,i,255,0,0,0):e.setIntColor(r,i,255,255,255,255);return e},MarvinColorModelConverter.rgbToHsv=function(t){for(var e,i,r,n=new Array(3*t.length),o=0;o<t.length;o++){e=(16711680&t[o])>>>16,i=(65280&t[o])>>>8,r=255&t[o],e/=255,i/=255,r/=255;var a,s,h,l=Math.max(Math.max(e,i),r),g=l-Math.min(Math.min(e,i),r);a=0!=g?l==e?i>=r?(i-r)/g*60:(i-r)/g*60+360:l==i?(r-e)/g*60+120:(e-i)/g*60+240:0,h=l,s=0!=g?g/h:0,n[3*o]=a,n[3*o+1]=s,n[3*o+2]=h}return n},MarvinColorModelConverter.hsvToRgb=function(t){for(var e=new Array(t.length/3),i=0,r=0;i<t.length;i+=3,r++){var n=t[i],o=t[i+1],a=t[i+2],s=Math.ceil(n/60%6),h=n/60-s,l=a*(1-o),g=a*(1-h*o),u=a*(1-(1-h)*o),p=0,M=0,c=0;switch(Math.ceil(s)){case 0:p=Math.ceil(255*a),M=Math.ceil(255*u),c=Math.ceil(255*l);break;case 1:p=Math.ceil(255*g),M=Math.ceil(255*a),c=Math.ceil(255*l);break;case 2:p=Math.ceil(255*l),M=Math.ceil(255*a),c=Math.ceil(255*u);break;case 3:p=Math.ceil(255*l),M=Math.ceil(255*g),c=Math.ceil(255*a);break;case 4:p=Math.ceil(255*u),M=Math.ceil(255*l),c=Math.ceil(255*a);break;case 5:p=Math.ceil(255*a),M=Math.ceil(255*l),c=Math.ceil(255*g)}e[r]=4278190080+(p<<16)+(M<<8)+c}return e},MarvinImage.COLOR_MODEL_RGB=0,MarvinImage.COLOR_MODEL_BINARY=1,MarvinImage.prototype.create=function(t,e){this.canvas=document.createElement("canvas"),this.canvas.width=t,this.canvas.height=e,this.ctx=this.canvas.getContext("2d"),this.imageData=this.ctx.getImageData(0,0,t,e),this.width=t,this.height=e},MarvinImage.prototype.setDimension=function(t,e){this.create(t,e)},MarvinImage.prototype.load=function(t,e){this.onload=e,this.image=new Image;var i=this;this.image.onload=function(){i.callbackImageLoaded(i)},this.image.crossOrigin="anonymous",this.image.src=t},MarvinImage.prototype.callbackImageLoaded=function(t){t.width=t.image.width,t.height=t.image.height,t.canvas=document.createElement("canvas"),t.canvas.width=t.image.width,t.canvas.height=t.image.height,t.ctx=t.canvas.getContext("2d"),t.ctx.drawImage(t.image,0,0),this.imageData=t.ctx.getImageData(0,0,t.getWidth(),t.getHeight()),null!=t.onload&&t.onload()},MarvinImage.prototype.clone=function(){var t=new MarvinImage(this.getWidth(),this.getHeight(),this.colorModel);return MarvinImage.copyColorArray(this,t),t},MarvinImage.prototype.clear=function(t){for(var e=0;e<this.getHeight();e++)for(var i=0;i<this.getWidth();i++)this.setIntColor(i,e,t)},MarvinImage.prototype.getColorModel=function(){return this.colorModel},MarvinImage.prototype.getAlphaComponent=function(t,e){var i=4*(e*this.getWidth()+t);return this.imageData.data[i+3]},MarvinImage.prototype.getIntComponent0=function(t,e){var i=4*(e*this.getWidth()+t);return this.imageData.data[i]},MarvinImage.prototype.getIntComponent1=function(t,e){var i=4*(e*this.getWidth()+t);return this.imageData.data[i+1]},MarvinImage.prototype.getIntComponent2=function(t,e){var i=4*(e*this.getWidth()+t);return this.imageData.data[i+2]},MarvinImage.prototype.setIntColor=function(t,e,i,r,n,o){null==r?this.setIntColor1(t,e,i):null==n&&null==o?this.setIntColor2(t,e,i,r):null==o?this.setIntColor3(t,e,i,r,n):this.setIntColor4(t,e,i,r,n,o)},MarvinImage.prototype.getIntColor=function(t,e){var i=4*(e*this.getWidth()+t);return 4294967296+(this.imageData.data[i+3]<<24)+(this.imageData.data[i]<<16)+(this.imageData.data[i+1]<<8)+this.imageData.data[i+2]},MarvinImage.prototype.setIntColor1=function(t,e,i){var r=(4278190080&i)>>>24,n=(16711680&i)>>16,o=(65280&i)>>8,a=255&i;this.setIntColor4(t,e,r,n,o,a)},MarvinImage.prototype.setBinaryColor=function(t,e,i){var r=e*this.getWidth()+t;this.arrBinaryColor[r]=i},MarvinImage.prototype.getBinaryColor=function(t,e){var i=e*this.getWidth()+t;return this.arrBinaryColor[i]},MarvinImage.copyColorArray=function(t,e){if(t.getColorModel()==e.getColorModel())switch(t.getColorModel()){case MarvinImage.COLOR_MODEL_RGB:for(i=0;i<t.imageData.data.length;i++)e.imageData.data[i]=t.imageData.data[i];break;case MarvinImage.COLOR_MODEL_BINARY:for(var i=0;i<t.arrBinaryColor.length;i++)e.arrBinaryColor[i]=t.arrBinaryColor[i]}},MarvinImage.prototype.drawRect=function(t,e,i,r,n){for(o=t;o<t+i;o++)this.setIntColor(o,e,n),this.setIntColor(o,e+(r-1),n);for(var o=e;o<e+r;o++)this.setIntColor(t,o,n),this.setIntColor(t+(i-1),o,n)},MarvinImage.prototype.fillRect=function(t,e,i,r,n){for(var o=t;o<t+i;o++)for(var a=e;a<e+r;a++)o<this.getWidth()&&a<this.getHeight()&&this.setIntColor(o,a,n)},MarvinImage.prototype.setIntColor2=function(t,e,i,r){var n=(16711680&r)>>16,o=(65280&r)>>8,a=255&r;this.setIntColor4(t,e,i,n,o,a)},MarvinImage.prototype.setIntColor3=function(t,e,i,r,n){this.setIntColor4(t,e,255,i,r,n)},MarvinImage.prototype.setIntColor4=function(t,e,i,r,n,o){var a=4*(e*this.getWidth()+t);this.imageData.data[a]=r,this.imageData.data[a+1]=n,this.imageData.data[a+2]=o,this.imageData.data[a+3]=i},MarvinImage.prototype.getWidth=function(){return this.width},MarvinImage.prototype.getHeight=function(){return this.height},MarvinImage.prototype.isValidPosition=function(t,e){return t>=0&&t<this.width&&e>=0&&e<this.height},MarvinImage.prototype.draw=function(t,e,i){null==e&&(e=0),null==i&&(i=0),t.getContext("2d").putImageData(this.imageData,e,i)},MarvinImageMask.prototype.getWidth=function(){return this.width},MarvinImageMask.prototype.getHeight=function(){return this.height},MarvinImageMask.prototype.addPixel=function(t,e){this.arrMask[t][e]=!0},MarvinImageMask.prototype.removePixel=function(t,e){this.arrMask[t][e]=!1},MarvinImageMask.prototype.clear=function(){if(null!=this.arrMask)for(var t=0;t<height;t++)for(var e=0;e<width;e++)this.arrMask[e][t]=!1},MarvinImageMask.prototype.getMask=function(){return this.arrMask},MarvinImageMask.prototype.addRectRegion=function(t,e,i,r){for(var n=t;n<t+i;n++)for(var o=e;o<e+r;o++)this.arrMask[n][o]=!0},MarvinImageMask.createNullMask=function(){return new MarvinImageMask(0,0)},MarvinImageMask.NULL_MASK=MarvinImageMask.createNullMask(),MarvinSegment.segmentMinDistance=function(t,e){for(var i,r,n=0;n<t.size()-1;n++)for(var o=n+1;o<t.size();o++)i=t[n],r=t[o],MarvinMath.euclidianDistance((i.x1+i.x2)/2,(i.y1+i.y2)/2,(r.x1+r.x2)/2,(r.y1+r.y2)/2)<e&&(t.splice(o,1),o--)},MarvinColor.prototype.setId=function(t){this.id=t},MarvinColor.prototype.getId=function(){return this.id},MarvinColor.prototype.setName=function(t){this.name=t},MarvinColor.prototype.getName=function(){return this.name};var MarvinJSUtils=new Object;MarvinJSUtils.createMatrix2D=function(t,e,i){for(var r=new Array(t),n=0;n<r.length;n++)r[n]=new Array(e),r[n].fill(i);return r},MarvinJSUtils.createMatrix3D=function(t,e,i,r){for(var n=new Array(t),o=0;o<n.length;o++){n[o]=new Array(e);for(var a=0;a<n[o].length;a++)n[o][a]=new Array(i),n[o][a].fill(r)}return n};var MarvinMath=new Object;MarvinMath.getTrueMatrix=function(t,e){for(var i=MarvinJSUtils.createMatrix2D(t,e),r=0;r<t;r++)for(var n=0;n<e;n++)i[r][n]=!0;return i},MarvinMath.scaleMatrix=function(t,e){for(var i=MarvinJSUtils.createMatrix2D(t.length,t.length),r=0;r<t.length;r++)for(var n=0;n<t.length;n++)i[r][n]=t[r][n]*e;return i},MarvinMath.euclideanDistance=function(t,e,i,r,n,o){return null!=o?MarvinMath.euclideanDistance3D(t,e,i,r,n,o):MarvinMath.euclideanDistance3D(t,e,i,r)},MarvinMath.euclideanDistance2D=function(t,e,i,r){var n=t-i,o=e-r;return Math.sqrt(n*n+o*o)},MarvinMath.euclideanDistance3D=function(t,e,i,r,n,o){var a=t-r,s=e-n,h=i-o;return Math.sqrt(a*a+s*s+h*h)},GaussianBlur.prototype.load=function(){this.RED=0,this.GREEN=1,this.BLUE=2,this.kernelMatrix=null,this.resultMatrix=null,this.appiledkernelMatrix=null,this.radius=null,this.setAttribute("radius",3)},GaussianBlur.prototype.process=function(t,e,i,r,n){this.radius=this.getAttribute("radius");var o,a=t.getWidth(),s=t.getHeight();this.kernelMatrix=this.getGaussianKernel(),this.resultMatrix=MarvinJSUtils.createMatrix3D(a,s,3,0),this.appiledkernelMatrix=MarvinJSUtils.createMatrix2D(a,s,0);for(var h=r.getMask(),l=0;l<a;l++)for(g=0;g<s;g++)(null==h||h[l][g])&&(o=t.getIntColor(l,g),this.applyKernel(l,g,o,e));for(l=0;l<a;l++)for(var g=0;g<s;g++)(null==h||h[l][g])&&(this.resultMatrix[l][g][this.RED]=this.resultMatrix[l][g][0]/this.appiledkernelMatrix[l][g]%256,this.resultMatrix[l][g][this.GREEN]=this.resultMatrix[l][g][1]/this.appiledkernelMatrix[l][g]%256,this.resultMatrix[l][g][this.BLUE]=this.resultMatrix[l][g][2]/this.appiledkernelMatrix[l][g]%256,e.setIntColor(l,g,t.getAlphaComponent(l,g),Math.floor(this.resultMatrix[l][g][0]),Math.floor(this.resultMatrix[l][g][1]),Math.floor(this.resultMatrix[l][g][2])))},GaussianBlur.prototype.getGaussianKernel=function(){for(var t,e,i,r=MarvinJSUtils.createMatrix2D(2*this.radius+1,2*this.radius+1),n=this.radius/3,o=1;o<=2*this.radius+1;o++)for(var a=1;a<=2*this.radius+1;a++)e=Math.abs(o-(this.radius+1)),i=Math.abs(a-(this.radius+1)),t=Math.sqrt(e*e+i*i),r[a-1][o-1]=1/(2*Math.PI*n*n)*Math.exp(-t*t/(2*n*n));return r},GaussianBlur.prototype.applyKernel=function(t,e,i,r){for(var n=e;n<e+2*this.radius;n++)for(var o=t;o<t+2*this.radius;o++)o-this.radius>=0&&o-this.radius<r.getWidth()&&n-this.radius>=0&&n-this.radius<r.getHeight()&&(this.resultMatrix[o-this.radius][n-this.radius][this.RED]+=((16711680&i)>>>16)*this.kernelMatrix[o-t][n-e],this.resultMatrix[o-this.radius][n-this.radius][this.GREEN]+=((65280&i)>>>8)*this.kernelMatrix[o-t][n-e],this.resultMatrix[o-this.radius][n-this.radius][this.BLUE]+=(255&i)*this.kernelMatrix[o-t][n-e],this.appiledkernelMatrix[o-this.radius][n-this.radius]+=this.kernelMatrix[o-t][n-e])},AlphaBoundary.prototype.load=function(){this.setAttribute("radius",5)},AlphaBoundary.prototype.process=function(t,e,i,r,n){for(var o=getAttribute("radius"),a=0;a<e.getHeight();a++)for(var s=0;s<e.getWidth();s++)this.alphaRadius(e,s,a,o)},AlphaBoundary.prototype.alphaRadius=function(t,e,i,r){for(var n,o=t.getAlphaComponent(e,i),a=0,s=0,h=r/2,l=i-h;l<i+h;l++)for(var g=e-h;g<e+h;g++)g>=0&&g<t.getWidth()&&l>=0&&l<t.getHeight()&&(a+=t.getAlphaComponent(g,l),s++);(n=a/s)<o&&t.setAlphaComponent(e,i,n)},BlackAndWhite.prototype.load=function(){this.grayScale=new GrayScale,this.setAttribute("level",10)},BlackAndWhite.prototype.process=function(t,e,i,r,n){this.grayScale.process(t,e);for(var o,a=this.getAttribute("level"),s=a/100*this.MAX_RLEVEL,h=0,l=0;l<e.getHeight();l++)for(var g=0;g<e.getWidth();g++)o=(o=t.getIntComponent0(g,l))<=127?Math.max(o*(1-(127-o)*s),0):Math.min(o*(1+(o-127)*s),255),h++<1&&(console.log("gray:"+o),console.log("level:"+a),console.log("rlevel:"+s)),e.setIntColor(g,l,255,Math.floor(o),Math.floor(o),Math.floor(o))},BrightnessAndContrast.prototype.load=function(){this.setAttribute("brightness",0),this.setAttribute("contrast",0)},BrightnessAndContrast.prototype.process=function(t,e,i,r,n){var o,a,s,h=this.getAttribute("brightness"),l=this.getAttribute("contrast");l=Math.pow((127+l)/127,2);for(g=0;g<t.getWidth();g++)for(u=0;u<t.getHeight();u++)o=t.getIntComponent0(g,u),a=t.getIntComponent1(g,u),s=t.getIntComponent2(g,u),a+=(1-a/255)*h,s+=(1-s/255)*h,(o+=(1-o/255)*h)<0&&(o=0),o>255&&(o=255),a<0&&(a=0),a>255&&(a=255),s<0&&(s=0),s>255&&(s=255),e.setIntColor(g,u,t.getAlphaComponent(g,u),Math.floor(o),Math.floor(a),Math.floor(s));for(var g=0;g<t.getWidth();g++)for(var u=0;u<t.getHeight();u++)o=e.getIntComponent0(g,u),a=e.getIntComponent1(g,u),s=e.getIntComponent2(g,u),o/=255,o-=.5,o*=l,o+=.5,a/=255,a-=.5,a*=l,a+=.5,a*=255,s/=255,s-=.5,s*=l,s+=.5,s*=255,(o*=255)<0&&(o=0),o>255&&(o=255),a<0&&(a=0),a>255&&(a=255),s<0&&(s=0),s>255&&(s=255),e.setIntColor(g,u,t.getAlphaComponent(g,u),Math.floor(o),Math.floor(a),Math.floor(s))},ColorChannel.prototype.load=function(){this.setAttribute("red",0),this.setAttribute("green",0),this.setAttribute("blue",0)},ColorChannel.prototype.process=function(t,e,i,r,n){var o=this.getAttribute("red"),a=this.getAttribute("green"),s=this.getAttribute("blue"),h=1+Math.abs(o/100*2.5),l=1+Math.abs(a/100*2.5),g=1+Math.abs(s/100*2.5);h=o>0?h:1/h,l=a>0?l:1/l,g=s>0?g:1/g;for(var u,p,M,c=0;c<t.getHeight();c++)for(var v=0;v<t.getWidth();v++)u=t.getIntComponent0(v,c),p=t.getIntComponent1(v,c),M=t.getIntComponent2(v,c),u=Math.min(u*h,255),p=Math.min(p*l,255),M=Math.min(M*g,255),e.setIntColor(v,c,255,u,p,M)},Emboss.prototype.load=function(){},Emboss.prototype.process=function(t,e,i,r,n){for(var o=r.getMask(),a=0;a<t.getWidth();a++)for(var s=0;s<t.getHeight();s++)if(null==o||o[a][s]){var h=0,l=0,g=0;s>0&&a>0?(h=t.getIntComponent0(a,s)-t.getIntComponent0(a-1,s-1),l=t.getIntComponent1(a,s)-t.getIntComponent1(a-1,s-1),g=t.getIntComponent2(a,s)-t.getIntComponent2(a-1,s-1)):(h=0,l=0,g=0);var u=h;Math.abs(l)>Math.abs(u)&&(u=l),Math.abs(g)>Math.abs(u)&&(u=g);var p=Math.max(Math.min(128+u,255),0);e.setIntColor(a,s,255,p,p,p)}else e.setIntColor(a,s,255,t.getIntColor(a,s))},GrayScale.prototype.load=function(){},GrayScale.prototype.process=function(t,e,i,r,n){var o;null!=r&&(o=r.getMask());for(var a,s,h,l,g=0;g<t.getWidth();g++)for(var u=0;u<t.getHeight();u++)(null==o||o[g][u])&&(a=t.getIntComponent0(g,u),s=t.getIntComponent1(g,u),h=t.getIntComponent2(g,u),l=Math.ceil(.3*a+.59*s+.11*h),e.setIntColor(g,u,t.getAlphaComponent(g,u),l,l,l))},Invert.prototype.load=function(){},Invert.prototype.process=function(t,e,i,r,n){for(var o,a,s,h=r.getMask(),l=0;l<t.getWidth();l++)for(var g=0;g<t.getHeight();g++)(null==h||h[l][g])&&(o=255-t.getIntComponent0(l,g),a=255-t.getIntComponent1(l,g),s=255-t.getIntComponent2(l,g),e.setIntColor(l,g,t.getAlphaComponent(l,g),o,a,s))},Sepia.prototype.load=function(){this.setAttribute("txtValue","20"),this.setAttribute("intensity",20)},Sepia.prototype.process=function(t,e,i,r,n){var o,a,s,h;h=this.getAttribute("intensity");t.getWidth(),t.getHeight();for(var l=r.getMask(),g=0;g<t.getWidth();g++)for(var u=0;u<t.getHeight();u++)(null==l||l[g][u])&&(o=a=s=((o=t.getIntComponent0(g,u))+(a=t.getIntComponent1(g,u))+(s=t.getIntComponent2(g,u)))/3,o=this.truncate(o+2*h),a=this.truncate(a+h),e.setIntColor(g,u,t.getAlphaComponent(g,u),o,a,s))},Sepia.prototype.truncate=function(t){return t<0?0:t>255?255:t},Thresholding.prototype.load=function(){this.setAttribute("threshold",125),this.setAttribute("thresholdRange",-1),this.setAttribute("neighborhood",-1),this.setAttribute("range",-1),this.pluginGray=new GrayScale},Thresholding.prototype.process=function(t,e,i,r,n){this.threshold=this.getAttribute("threshold"),this.thresholdRange=this.getAttribute("thresholdRange"),this.neighborhood=this.getAttribute("neighborhood"),this.range=this.getAttribute("range"),-1==this.thresholdRange&&(this.thresholdRange=255-threshold),this.pluginGray.process(t,e,i,r,n);var o=r.getMask();-1==this.neighborhood&&-1==this.range?this.hardThreshold(t,e,o):this.contrastThreshold(t,e)},Thresholding.prototype.hardThreshold=function(t,e,i){for(var r=0;r<t.getHeight();r++)for(var n=0;n<t.getWidth();n++)if(null==i||i[n][r]){var o=t.getIntComponent0(n,r);o<this.threshold||o>this.threshold+this.thresholdRange?e.setIntColor(n,r,t.getAlphaComponent(n,r),0,0,0):e.setIntColor(n,r,t.getAlphaComponent(n,r),255,255,255)}},Thresholding.prototype.contrastThreshold=function(t,e){this.range=1;for(var i=0;i<t.getWidth();i++)for(var r=0;r<t.getHeight();r++)checkNeighbors(i,r,neighborhood,neighborhood,t)?e.setIntColor(i,r,0,0,0):e.setIntColor(i,r,255,255,255)},Thresholding.prototype.checkNeighbors=function(t,e,i,r,n){var o,a=0;o=n.getIntComponent0(t,e);for(var s=0-i;s<=i;s++)for(var h=0-r;h<=r;h++)0==s&&0==h||o<getSafeColor(t+s,e+h,n)-range&&-1!=getSafeColor(t+s,e+h,n)&&a++;return a>i*r*.5},Thresholding.prototype.getSafeColor=function(t,e,i){return t>=0&&t<i.getWidth()&&e>=0&&e<i.getHeight()?i.getIntComponent0(t,e):-1},ThresholdingNeighborhood.prototype.load=function(){this.setAttribute("neighborhoodSide",10),this.setAttribute("samplingPixelDistance",1),this.setAttribute("thresholdPercentageOfAverage",1)},ThresholdingNeighborhood.prototype.process=function(t,e,i,r,n){for(var o=getAttribute("neighborhoodSide"),a=getAttribute("samplingPixelDistance"),s=getAttribute("thresholdPercentageOfAverage"),h=0;h<t.getHeight();h++)for(var l=0;l<t.getWidth();l++)this.theshold(t,e,l,h,s,o,a)},ThresholdingNeighborhood.prototype.theshold=function(t,e,i,r,n,o,a){for(var s=-1,h=-1,l=0,g=0,u=a,p=r-o/2;p<r+(u+o/2);p+=u)for(var M=i-o/2;M<i+o/2;M+=u)if(M>=0&&p>=0&&M<t.getWidth()&&p<t.getHeight()){var c=t.getIntComponent0(M,p);(-1==s||c<s)&&(s=c),(-1==h||c>h)&&(h=c),g+=c,l++}g/=l,(c=t.getIntComponent0(i,r))<g*n||h-s<=30?e.setIntColor(i,r,255,0,0,0):e.setIntColor(i,r,255,255,255,255)},Convolution.prototype.load=function(){this.setAttribute("matrix",null)},Convolution.prototype.process=function(t,e,i,r,n){var o=this.getAttribute("matrix");if(null!=o&&o.length>0)for(var a=0;a<t.getHeight();a++)for(var s=0;s<t.getWidth();s++)a>=o.length/2&&a<t.getHeight()-o.length/2&&s>=o[0].length/2&&s<t.getWidth()-o[0].length/2?this.applyMatrix(s,a,o,t,e):e.setIntColor(s,a,4278190080)},Convolution.prototype.applyMatrix=function(t,e,i,r,n){for(var o,a,s=0,h=0,l=0,g=Math.ceil(i[0].length/2),u=Math.ceil(i.length/2),p=0;p<i.length;p++)for(var M=0;M<i[0].length;M++)0!=i[p][M]&&(a=e+(p-u),(o=t+(M-g))>=0&&o<n.getWidth()&&a>=0&&a<n.getHeight()&&(s+=i[p][M]*r.getIntComponent0(o,a),h+=i[p][M]*r.getIntComponent1(o,a),l+=i[p][M]*r.getIntComponent2(o,a)));s=Math.abs(s),h=Math.abs(h),l=Math.abs(l),s+=n.getIntComponent0(t,e),h+=n.getIntComponent1(t,e),l+=n.getIntComponent2(t,e),s=Math.min(s,255),h=Math.min(h,255),l=Math.min(l,255),s=Math.max(s,0),h=Math.max(h,0),l=Math.max(l,0),n.setIntColor(t,e,r.getAlphaComponent(t,e),Math.floor(s),Math.floor(h),Math.floor(l))},Moravec.prototype.load=function(){this.setAttribute("matrixSize",3),this.setAttribute("threshold",0)},Moravec.prototype.process=function(t,e,i,r,n){var o=this.getAttribute("matrixSize"),a=this.getAttribute("threshold"),s=new MarvinImage(t.getWidth(),t.getHeight());Marvin.grayScale(t,s);for(var h=MarvinJSUtils.createMatrix2D(s.getWidth(),s.getHeight(),0),l=MarvinJSUtils.createMatrix2D(s.getWidth(),s.getHeight(),0),g=0;g<s.getHeight();g++)for(u=0;u<s.getWidth();u++)h[u][g]=this.c(u,g,o,s),h[u][g]<a&&(h[u][g]=0);for(var u=0;u<h.length;u++)for(g=0;g<h[u].length;g++)l[u][g]=this.nonmax(u,g,o,h),l[u][g]>0&&(l[u][g]=1);null!=i&&i.set("cornernessMap",l)},Moravec.prototype.nonmax=function(t,e,i,r){var n=Math.floor(i/2);if(t-(n+1)>=0&&t+(n+1)<r.length&&e-(n+1)>=0&&e+(n+1)<r[0].length)for(var o=-n;o<=n;o++)for(var a=-n;a<=n;a++)if((0!=o||0!=a)&&r[t][e]<r[t+o][e+a])return 0;return r[t][e]},Moravec.directions=[[1,0],[-1,0],[0,1],[0,-1],[-1,-1],[1,-1],[-1,1],[1,1]],Moravec.prototype.c=function(t,e,i,r){var n,o=-1,a=Math.floor(i/2);if(t-(a+1)>=0&&t+(a+1)<r.getWidth()&&e-(a+1)>=0&&e+(a+1)<r.getHeight())for(var s=0;s<Moravec.directions.length;s++){n=0;for(var h=-a;h<=a;h++)for(var l=-a;l<=a;l++)n+=Math.pow(r.getIntComponent0(t+h,e+l)-r.getIntComponent0(t+h+Moravec.directions[s][0],e+l+Moravec.directions[s][1]),2);(-1==o||n<o)&&(o=n)}return o},Prewitt.prototype.load=function(){this.convolution=new Convolution,this.setAttribute("intensity",1)},Prewitt.prototype.process=function(t,e,i,r,n){var o=this.getAttribute("intensity");1==o?(this.convolution.setAttribute("matrix",this.matrixPrewittX),this.convolution.process(t,e,null,r,this.previewMode),this.convolution.setAttribute("matrix",this.matrixPrewittY),this.convolution.process(t,e,null,r,this.previewMode)):(this.convolution.setAttribute("matrix",MarvinMath.scaleMatrix(this.matrixPrewittX,o)),this.convolution.process(t,e,null,r,n),this.convolution.setAttribute("matrix",MarvinMath.scaleMatrix(this.matrixPrewittY,o)),this.convolution.process(t,e,null,r,n))},BoundaryFill.prototype.load=function(){this.setAttribute("x",0),this.setAttribute("y",0),this.setAttribute("color",4294901760),this.setAttribute("tile",null),this.setAttribute("threshold",0)},BoundaryFill.prototype.process=function(t,e,i,r,n){var o,a,s,h=new Array,l=this.getAttribute("x"),g=this.getAttribute("y"),u=this.getAttribute("tile");if(this.threshold=this.getAttribute("threshold"),e.isValidPosition(l,g)){t.getIntColor(l,g);var p=t.getIntComponent0(l,g),M=t.getIntComponent1(l,g),c=t.getIntComponent2(l,g),v=this.getAttribute("color"),d=MarvinJSUtils.createMatrix2D(e.getWidth(),e.getHeight,!1);for(d[l][g]=!0,h.push(new MarvinPoint(l,g));h.length>0;){for(a=new MarvinPoint((o=h.splice(0,1)[0]).x,o.y),s=new MarvinPoint(o.x,o.y);;){if(!(a.x-1>=0&&this.match(t,a.x-1,a.y,p,M,c,this.threshold))||d[a.x-1][a.y])break;a.x--}for(;;){if(!(s.x+1<t.getWidth()&&this.match(t,s.x+1,s.y,p,M,c,this.threshold))||d[s.x+1][s.y])break;s.x++}for(var f=a.x;f<=s.x;f++)d[f][o.y]=!0,o.y-1>=0&&this.match(t,f,o.y-1,p,M,c,this.threshold)&&!d[f][o.y-1]&&h.push(new MarvinPoint(f,o.y-1)),o.y+1<e.getHeight()&&this.match(t,f,o.y+1,p,M,c,this.threshold)&&!d[f][o.y+1]&&h.push(new MarvinPoint(f,o.y+1))}if(null!=u);else for(var m=0;m<e.getHeight();m++)for(var b=0;b<e.getWidth();b++)d[b][m]&&e.setIntColor(b,m,v)}},BoundaryFill.prototype.match=function(t,e,i,r,n,o,a){return Math.abs(t.getIntComponent0(e,i)-r)+Math.abs(t.getIntComponent1(e,i)-n)+Math.abs(t.getIntComponent2(e,i)-o)<=a},ErrorDiffusion.prototype.load=function(){this.threshold=128},ErrorDiffusion.prototype.process=function(t,e,i,r,n){var o,a;Marvin.grayScale(t,e,i,r,n);var s;null!=r&&(s=r.getMask());for(var h=0;h<e.getHeight();h++)for(var l=0;l<e.getWidth();l++)(null==s||s[l][h])&&((o=e.getIntComponent0(l,h))>this.threshold?(e.setIntColor(l,h,t.getAlphaComponent(l,h),255,255,255),a=-(255-o)):(e.setIntColor(l,h,t.getAlphaComponent(l,h),0,0,0),a=o),l+1<e.getWidth()&&(o=e.getIntComponent0(l+1,h),o+=Math.floor(.4375*a),o=this.getValidGray(o),e.setIntColor(l+1,h,t.getAlphaComponent(l+1,h),o,o,o),h+1<e.getHeight()&&(o=e.getIntComponent0(l+1,h+1),o+=Math.floor(.0625*a),o=this.getValidGray(o),e.setIntColor(l+1,h+1,t.getAlphaComponent(l+1,h+1),o,o,o))),h+1<e.getHeight()&&(o=e.getIntComponent0(l,h+1),o+=Math.floor(.3125*a),o=this.getValidGray(o),e.setIntColor(l,h+1,t.getAlphaComponent(l,h+1),o,o,o),l-1>=0&&(o=e.getIntComponent0(l-1,h+1),o+=Math.floor(.1875*a),o=this.getValidGray(o),e.setIntColor(l-1,h+1,t.getAlphaComponent(l-1,h+1),o,o,o))))},ErrorDiffusion.prototype.getValidGray=function(t){return t<0?0:t>255?255:t};var MarvinAbstractImagePlugin=new Object;MarvinAbstractImagePlugin.super=function(t){t.attributes={},t.setAttribute=MarvinAbstractImagePlugin.setAttribute,t.getAttribute=MarvinAbstractImagePlugin.getAttribute},MarvinAbstractImagePlugin.setAttribute=function(t,e){this.attributes[t]=e},MarvinAbstractImagePlugin.getAttribute=function(t,e){return this.attributes[t]},Closing.prototype.load=function(){this.matrix=MarvinJSUtils.createMatrix2D(3,3,!0),this.setAttribute("matrix",3)},Closing.prototype.process=function(t,e,i,r,n){var o=this.getAttribute("matrix");t.getColorModel()==MarvinImage.COLOR_MODEL_BINARY&&null!=o&&(Marvin.morphologicalDilation(t,e,o),MarvinImage.copyColorArray(e,t),Marvin.morphologicalErosion(t,e,o))},Dilation.prototype.load=function(){this.matrix=MarvinJSUtils.createMatrix2D(3,3,!0),this.setAttribute("matrix",3)},Dilation.prototype.process=function(t,e,i,r,n){var o=this.getAttribute("matrix");if(t.getColorModel()==MarvinImage.COLOR_MODEL_BINARY&&null!=o){MarvinImage.copyColorArray(t,e);for(var a=0;a<t.getHeight();a++)for(var s=0;s<t.getWidth();s++)this.applyMatrix(s,a,o,t,e)}},Dilation.prototype.applyMatrix=function(t,e,i,r,n){var o,a,s=i[0].length/2,h=i.length/2;if(r.getBinaryColor(t,e))for(var l=0;l<i.length;l++)for(var g=0;g<i.length;g++)l==h&&g==s||!i[l][g]||(a=e+(l-h),(o=t+(g-s))>0&&o<n.getWidth()&&a>0&&a<n.getHeight()&&n.setBinaryColor(o,a,!0))},Erosion.prototype.load=function(){this.matrix=MarvinJSUtils.createMatrix2D(3,3,!0),this.setAttribute("matrix",3)},Erosion.prototype.process=function(t,e,i,r,n){var o=this.getAttribute("matrix");if(t.getColorModel()==MarvinImage.COLOR_MODEL_BINARY&&null!=o){MarvinImage.copyColorArray(t,e);for(var a=0;a<t.getHeight();a++)for(var s=0;s<t.getWidth();s++)this.applyMatrix(s,a,o,t,e)}},Erosion.prototype.applyMatrix=function(t,e,i,r,n){var o,a,s=Math.floor(i[0].length/2),h=Math.floor(i.length/2);if(!r.getBinaryColor(t,e))for(var l=0;l<i.length;l++)for(var g=0;g<i[0].length;g++)l==h&&g==s||!i[l][g]||(a=e+(l-h),(o=t+(g-s))>=0&&o<n.getWidth()&&a>=0&&a<n.getHeight()&&n.setBinaryColor(o,a,!1))},Crop.prototype.load=function(){this.setAttribute("x",0),this.setAttribute("y",0),this.setAttribute("width",0),this.setAttribute("height",0)},Crop.prototype.process=function(t,e,i,r,n){var o=this.getAttribute("x"),a=this.getAttribute("y"),s=this.getAttribute("width"),h=this.getAttribute("height");e.setDimension(s,h);for(var l=o;l<o+s;l++)for(var g=a;g<a+h;g++)e.setIntColor(l-o,g-a,t.getIntColor(l,g))},FloodfillSegmentation.prototype.load=function(){this.setAttribute("returnType","MarvinSegment")},FloodfillSegmentation.prototype.process=function(t,e,i,r,n){if(null!=i){var o=this.getAttribute("returnType"),a=t.clone(),s=this.floodfillSegmentation(t,a);switch(o){case"MarvinSegment":i.set("segments",s);break;case"MarvinBlobSegment":i.set("blobSegments",blobSegments(a,s))}}},FloodfillSegmentation.prototype.floodfillSegmentation=function(t,e){e.clear(4278190080);for(var i=1,r=0;r<t.getHeight();r++)for(s=0;s<t.getWidth();s++)if(0==(16777215&(h=e.getIntColor(s,r)))&&t.getAlphaComponent(s,r)>0){var n=4278190080|i++;Marvin.boundaryFill(t,e,s,r,n)}for(var o,a=new Array(i-1),r=0;r<e.getHeight();r++)for(var s=0;s<e.getWidth();s++){var h=16777215&e.getIntColor(s,r);16777215!=h&&h>0&&(null==(o=a[h-1])&&(o=new MarvinSegment,a[h-1]=o),(-1==o.x1||s<o.x1)&&(o.x1=s),(-1==o.x2||s>o.x2)&&(o.x2=s),o.width=o.x2-o.x1+1,(-1==o.y1||r<o.y1)&&(o.y1=r),(-1==o.y2||r>o.y2)&&(o.y2=r),o.height=o.y2-o.y1+1,o.area++)}return a},FloodfillSegmentation.prototype.blobSegments=function(t,e){for(var i,r,n=new Array(e.length),o=0;o<e.length;o++){r=e[o],i=4278190080+(o+1),n[o]=new MarvinBlobSegment(r.x1,r.y1);var a=new MarvinBlob(r.width,r.height);n[o].setBlob(a);for(var s=r.y1;s<=r.y2;s++)for(var h=r.x1;h<=r.x2;h++)t.getIntColor(h,s)==i&&a.setValue(h-r.x1,s-r.y1,!0)}return n},Scale.prototype.load=function(){this.setAttribute("newWidth",0),this.setAttribute("newHeight",0)},Scale.prototype.process=function(t,e,i,r,n){if(!n){var o=t.getWidth(),a=t.getHeight(),s=this.getAttribute("newWidth"),h=this.getAttribute("newHeight");e.getWidth()==s&&e.getHeight()==h||e.setDimension(s,h);for(var l,g,u=Math.floor((o<<16)/s),p=Math.floor((a<<16)/h),M=0;M<h;M++)for(var c=0;c<s;c++)l=Math.floor(c*u>>16),g=Math.floor(M*p>>16),e.setIntColor(c,M,t.getAlphaComponent(l,g),t.getIntColor(l,g))}},MarvinAttributes.prototype.set=function(t,e){this.hashAttributes[t]=e},MarvinAttributes.prototype.get=function(t,e){var i=this.hashAttributes[t];return null!=i?i:e},MarvinAttributes.prototype.clone=function(){var t=new MarvinAttributes;for(var e in this.hashAttributes)t.set(e,this.hashAttributes[e]);return t},MarvinPoint.prototype.setX=function(t){this.x=t},MarvinPoint.prototype.getX=function(){return this.x},MarvinPoint.prototype.setY=function(t){this.y=y},MarvinPoint.prototype.getY=function(){return this.y};var marvinLoadPluginMethods=function(t){Marvin.plugins=new Object,Marvin.plugins.alphaBoundary=new AlphaBoundary,Marvin.alphaBoundary=function(t,e,i){Marvin.plugins.alphaBoundary.setAttribute(i),Marvin.plugins.alphaBoundary.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.blackAndWhite=new BlackAndWhite,Marvin.blackAndWhite=function(t,e,i){Marvin.plugins.blackAndWhite.setAttribute("level",i),Marvin.plugins.blackAndWhite.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.boundaryFill=new BoundaryFill,Marvin.boundaryFill=function(t,e,i,r,n,o){Marvin.plugins.boundaryFill.setAttribute("x",i),Marvin.plugins.boundaryFill.setAttribute("y",r),Marvin.plugins.boundaryFill.setAttribute("color",n),null!=o&&Marvin.plugins.boundaryFill.setAttribute("threshold",o),Marvin.plugins.boundaryFill.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.brightnessAndContrast=new BrightnessAndContrast,Marvin.brightnessAndContrast=function(t,e,i,r){Marvin.plugins.brightnessAndContrast.setAttribute("brightness",i),Marvin.plugins.brightnessAndContrast.setAttribute("contrast",r),Marvin.plugins.brightnessAndContrast.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.colorChannel=new ColorChannel,Marvin.colorChannel=function(t,e,i,r,n){Marvin.plugins.colorChannel.setAttribute("red",i),Marvin.plugins.colorChannel.setAttribute("green",r),Marvin.plugins.colorChannel.setAttribute("blue",n),Marvin.plugins.colorChannel.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.crop=new Crop,Marvin.crop=function(t,e,i,r,n,o){Marvin.plugins.crop.setAttribute("x",i),Marvin.plugins.crop.setAttribute("y",r),Marvin.plugins.crop.setAttribute("width",n),Marvin.plugins.crop.setAttribute("height",o),Marvin.plugins.crop.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.emboss=new Emboss,Marvin.emboss=function(t,e){Marvin.plugins.emboss.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.halftoneErrorDiffusion=new ErrorDiffusion,Marvin.halftoneErrorDiffusion=function(t,e){Marvin.plugins.halftoneErrorDiffusion.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.floodfillSegmentation=new FloodfillSegmentation,Marvin.floodfillSegmentation=function(t){var e=new MarvinAttributes;return Marvin.plugins.floodfillSegmentation.setAttribute("returnType","MarvinSegment"),Marvin.plugins.floodfillSegmentation.process(t,null,e,MarvinImageMask.NULL_MASK,!1),e.get("segments")},Marvin.plugins.gaussianBlur=new GaussianBlur,Marvin.gaussianBlur=function(t,e,i){Marvin.plugins.gaussianBlur.setAttribute("radius",Marvin.getValue(i,3)),Marvin.plugins.gaussianBlur.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.invertColors=new Invert,Marvin.invertColors=function(t,e){Marvin.plugins.invertColors.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.grayScale=new GrayScale,Marvin.grayScale=function(t,e){Marvin.plugins.grayScale.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.moravec=new Moravec,Marvin.moravec=function(t,e,i,r){var n=new MarvinAttributes;return Marvin.plugins.moravec.setAttribute("matrixSize",i),Marvin.plugins.moravec.setAttribute("threshold",r),Marvin.plugins.moravec.process(t,e,n,MarvinImageMask.NULL_MASK,!1),n.get("cornernessMap")},Marvin.plugins.morphologicalDilation=new Dilation,Marvin.morphologicalDilation=function(t,e,i){Marvin.plugins.morphologicalDilation.setAttribute("matrix",i),Marvin.plugins.morphologicalDilation.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.morphologicalErosion=new Erosion,Marvin.morphologicalErosion=function(t,e,i){Marvin.plugins.morphologicalErosion.setAttribute("matrix",i),Marvin.plugins.morphologicalErosion.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.morphologicalClosing=new Closing,Marvin.morphologicalClosing=function(t,e,i){Marvin.plugins.morphologicalClosing.setAttribute("matrix",i),Marvin.plugins.morphologicalClosing.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.prewitt=new Prewitt,Marvin.prewitt=function(t,e,i){Marvin.plugins.prewitt.setAttribute("intensity",Marvin.getValue(i,1)),Marvin.plugins.prewitt.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.scale=new Scale,Marvin.scale=function(t,e,i,r){if(null==r){var n=t.getHeight()/t.getWidth();r=Math.floor(n*i)}Marvin.plugins.scale.setAttribute("newWidth",i),Marvin.plugins.scale.setAttribute("newHeight",r),Marvin.plugins.scale.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.sepia=new Sepia,Marvin.sepia=function(t,e,i){Marvin.plugins.sepia.setAttribute("intensity",i),Marvin.plugins.sepia.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.thresholding=new Thresholding,Marvin.thresholding=function(t,e,i,r){Marvin.plugins.thresholding.setAttribute("threshold",i),Marvin.plugins.thresholding.setAttribute("thresholdRange",r),Marvin.plugins.thresholding.process(t,e,null,MarvinImageMask.NULL_MASK,!1)},Marvin.plugins.thresholdingNeighborhood=new ThresholdingNeighborhood,Marvin.thresholdingNeighborhood=function(t,e,i,r,n){Marvin.plugins.thresholdingNeighborhood.setAttribute("thresholdPercentageOfAverage",i),Marvin.plugins.thresholdingNeighborhood.setAttribute("neighborhoodSide",r),Marvin.plugins.thresholdingNeighborhood.setAttribute("samplingPixelDistance",n),Marvin.plugins.thresholdingNeighborhood.process(t,e,null,MarvinImageMask.NULL_MASK,!1)}},Marvin=new Object;Marvin.getValue=function(t,e){return null!=t?t:e},marvinLoadPluginMethods();